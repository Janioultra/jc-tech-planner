<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>JC-Tech Planner</title>
    
    <!-- Estilos visuais da página e do simulador -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Cor de fundo verde bem clara */
            color: #333;
            padding: 1rem;
        }
        .container {
            max-width: 1280px;
            margin: auto;
            background-color: transparent; /* Alterado para transparente */
            padding: 2rem;
            border-radius: 12px;
            /* box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); Removido */
        }
        .section-card {
            background-color: #dcfce7; /* Cor de fundo verde mais sutil para os cards */
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid #bbf7d0; /* Borda verde clara */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .input-field {
            @apply w-24 text-xs p-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out flex-shrink-0;
            text-align: center;
        }
        .result-field {
            @apply w-24 text-center text-xs p-1 border border-gray-200 rounded-md bg-gray-100 font-semibold text-gray-700 flex-shrink-0;
        }
        .signal-good { @apply bg-green-100 border-green-300 text-green-800; }
        .signal-warn { @apply bg-yellow-100 border-yellow-300 text-yellow-800; }
        .signal-bad { @apply bg-red-100 border-red-300 text-red-800; }
        .top-button {
            @apply bg-white text-gray-700 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-100 transition flex items-center border border-gray-300;
        }
        .tab-button {
            @apply whitespace-nowrap py-3 px-4 font-medium text-lg transition-colors duration-200 border-b-2;
        }
        .tab-button:not(.tab-active) {
            @apply text-gray-500 border-gray-200 hover:text-gray-700 hover:border-gray-300;
        }
        .tab-active {
            @apply text-white rounded-t-lg shadow-md border-transparent;
        }
        #tab-desbalanceada.tab-active {
            background: linear-gradient(to right, #F97316, #EF4444); /* orange-500 to red-600 */
        }
        #tab-balanceada.tab-active {
            background: linear-gradient(to right, #0891B2, #14B8A6); /* cyan-600 to teal-500 */
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loss-detail {
            @apply w-24 text-xs text-center text-red-600 font-medium p-1 flex-shrink-0;
        }
        .geo-button {
            @apply mt-2 px-2 py-1 text-xs font-bold rounded-lg shadow-sm transition-colors duration-150;
        }
        .manual-signal-field {
          @apply mt-2 w-full text-center text-xs text-gray-500;
        }
        [contenteditable=true]:empty:before {
            content: attr(data-placeholder);
            pointer-events: none;
            display: block; /* For Firefox */
            color: #9ca3af; /* gray-400 */
            font-style: italic;
        }
        .printable-only-description {
            display: none;
        }
        .section-title {
            @apply text-xl font-bold text-white bg-blue-600 mb-4 text-center p-2 rounded-md;
        }
        .calc-btn {
            @apply text-xl font-bold py-4 rounded-md transition-colors duration-150 ease-in-out;
        }
        #calc-display {
            overflow-x: auto;
            white-space: nowrap;
        }
        
       @media print {
            body:not(.cto-print-mode) * { visibility: hidden; }
            body:not(.cto-print-mode) #print-wrapper,
            body:not(.cto-print-mode) #print-wrapper * {
                visibility: visible;
            }

            body.cto-print-mode > .container > header,
            body.cto-print-mode .section-card.printable-area:first-of-type,
            body.cto-print-mode .border-b.no-print,
            body.cto-print-mode .tab-panel:not(.active-for-print),
            body.cto-print-mode .section-card.printable-area:last-of-type,
            body.cto-print-mode footer { 
                display: none;
            }

            body.cto-print-mode .no-print {
                display: none !important;
            }
            
            body.cto-print-mode .tab-panel.active-for-print {
                display: block !important;
            }

            #print-wrapper { position: absolute; left: 0; top: 0; width: 100%; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 9pt; }
            #main-title-print, #technician-name-print { display: block !important; visibility: visible; }
            .printable-area { box-shadow: none !important; border: none !important; }
            h2 { font-size: 1.25rem; }
            #network-layout-container, #balanced-network-container { gap: 0.5rem; }
            .cto-card-print { width: 240px !important; page-break-inside: avoid; }
            .printable-only-description { display: block; margin-top: 0.5rem; text-align: left; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="text-center mb-8 no-print">
            <h1 id="main-title" class="text-3xl md:text-4xl font-extrabold text-gray-800">JC-Tech Planner</h1>
             <div class="flex items-center gap-2 flex-wrap justify-center mt-4">
                <input type="file" id="file-input" class="hidden" accept=".json" onchange="loadProjectFromFile(event)">

                <!-- Botão de Menu Unificado -->
                <div class="relative inline-block text-left">
                    <div>
                        <button type="button" class="text-white bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-700 hover:to-violet-700 font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300 ease-in-out flex items-center" id="menu-button" onclick="toggleMenu()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                            </svg>
                            Menu
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                     <span id="save-status" class="text-sm font-semibold text-gray-500 ml-4"></span>
                    <div id="main-menu-dropdown" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10" role="menu" aria-orientation="vertical" aria-labelledby="menu-button">
                        <div class="py-1" role="none">
                            <!-- Ações de Projeto -->
                            <label for="file-input" title="Carregar um backup salvo" class="text-gray-700 group flex items-center px-4 py-2 text-sm cursor-pointer hover:bg-gray-100" role="menuitem">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 group-hover:text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                                Carregar Backup
                            </label>
                            <a href="#" onclick="downloadBackup()" title="Baixar um backup do projeto" class="text-gray-700 group flex items-center px-4 py-2 text-sm" role="menuitem">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 group-hover:text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 1a1 1 0 00-1 1v6a1 1 0 102 0V6a1 1 0 00-1-1z" /></svg>
                                Baixar Backup
                            </a>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="py-1" role="none">
                             <a href="#" onclick="window.print()" title="Imprimir Relatório Completo" class="text-gray-700 group flex items-center px-4 py-2 text-sm" role="menuitem">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 group-hover:text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd" /></svg>
                                Imprimir Relatório
                            </a>
                        </div>
                        <div class="border-t border-gray-100"></div>
                        <div class="py-1" role="none">
                            <!-- Ferramentas -->
                            <a href="#" onclick="openCalculatorModal()" class="text-gray-700 group flex items-center px-4 py-2 text-sm" role="menuitem">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 group-hover:text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm1 2a1 1 0 00-1 1v2a1 1 0 001 1h6a1 1 0 001-1V5a1 1 0 00-1-1H7zM6 9a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm0 4a1 1 0 011-1h2a1 1 0 110 2H7a1 1 0 01-1-1zm4-4a1 1 0 100 2h2a1 1 0 100-2h-2zm0 4a1 1 0 100 2h2a1 1 0 100-2h-2z" clip-rule="evenodd" />
                                </svg>
                                Calculadora
                            </a>
                            <a href="#" onclick="openWeatherModal()" class="text-gray-700 group flex items-center px-4 py-2 text-sm" role="menuitem">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-400 group-hover:text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                     <path fill-rule="evenodd" d="M15.312 11.23c.27-.225.438-.562.438-.937 0-.71-.563-1.282-1.28-1.282H14.25c-.2-.51-.487-.975-.85-1.375.225-.562.8-.975 1.5-1.2.71-.225 1.137-.938 1.012-1.65-.125-.71-.8-1.2-1.5-1.012-1.1.27-1.938.987-2.325 1.95-.525-.262-1.1-.45-1.7-.563V3.312c0-.71-.563-1.28-1.28-1.28-.718 0-1.282.563-1.282 1.28v.525c-.6.112-1.175.3-1.7.563-.387-.963-1.225-1.68-2.325-1.95-.71-.187-1.375.3-1.5,1.012-.125.712.3,1.425,1.012,1.65.7.225,1.275.638,1.5,1.2-.363.4-.65.862-.85,1.375H4.28c-.718 0-1.28.572-1.28,1.282s.562.938.437.938c.138 0 .225 0 .338-.037a.81.81 0 01.812.812c0 .412-.3.75-.712.812a.81.81 0 01-.812-.812c0-.075 0-.15.038-.225-.263-.262-.438-.637-.438-1.05 0-1.137.938-2.062 2.063-2.062h.225c.45-1.012 1.2-1.85 2.138-2.425C8.038 3.65 7.1 3.2 6.092 3.425c-1.238.262-2.1,1.387-1.912,2.625.187,1.237 1.388,2.1 2.625,1.912.225-.038.45-.113.675-.225.3.675.712,1.275,1.237,1.762H8.43c-1.137,0-2.062.925-2.062,2.063 0,.412.175.787.438,1.05-.037.075-.037.15-.037.225a.81.81 0 01-.812.812c-.412-.062-.712-.4-.712-.812a.81.81 0 01.812-.812c.113.037.2.037.338.037h.225v.225c0,1.138.925,2.063 2.063,2.063h.275c-.488.938-.75,2.013-.75,3.125 0,.375.037.75.112,1.125H8.43c-1.137,0-2.062.925-2.062,2.062s.925,2.063,2.062,2.063h3.125c1.138,0,2.063-.925,2.063-2.063s-.925-2.062-2.063-2.062h-.262c.075-.375.113-.75.113-1.125 0-1.112-.262-2.187-.75-3.125h.275c1.138,0,2.063-.925,2.063-2.063v-.225h.225c.137,0,.225,0,.337-.037.27.225.438.562.438.937z" clip-rule="evenodd"/>
                                </svg>
                                Previsão do Tempo
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </header>

         <div id="print-wrapper">
            <h1 id="main-title-print" class="text-3xl font-bold text-center mb-2 hidden"></h1>
            <h3 id="technician-name-print" class="text-xl font-normal text-center text-gray-600 mb-6 hidden"></h3>
            
            <div class="section-card printable-area">
                <div class="space-y-6">
                    <div>
                        <h2 class="section-title">Configurações Gerais do Projeto</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                            <div class="flex flex-col">
                                <label for="project-name-input" class="font-semibold text-gray-600 mb-1">Nome do Projeto (Localidade)</label>
                                <input id="project-name-input" oninput="handleProjectNameChange(this.value)" type="text" placeholder="Ex: Bairro Centro" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                            </div>
                            <div class="flex flex-col">
                                <label for="technician-name-input" class="font-semibold text-gray-600 mb-1">Técnico(s) Responsável(is)</label>
                                <input id="technician-name-input" oninput="saveTechnicianName(this.value)" type="text" placeholder="Ex: João da Silva" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <h2 class="section-title">Detalhes da Conexão na OLT</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                           <div class="flex flex-col">
                              <label for="olt-port-input" class="font-semibold text-gray-600 mb-1">Porta da OLT</label>
                              <input id="olt-port-input" oninput="handleOltDetailsChange('oltPortNumber', this.value)" type="text" placeholder="Ex: 0/1/0" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                          </div>
                          <div class="flex flex-col">
                              <label for="dio-group-input" class="font-semibold text-gray-600 mb-1">Grupo DIO</label>
                              <input id="dio-group-input" oninput="handleOltDetailsChange('dioGroup', this.value)" type="text" placeholder="Ex: A1" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                          </div>
                          <div class="flex flex-col">
                              <label for="fiber-color-input" class="font-semibold text-gray-600 mb-1">Cor da Fibra</label>
                              <input id="fiber-color-input" oninput="handleOltDetailsChange('fiberColor', this.value)" type="text" placeholder="Ex: Verde" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                          </div>
                        </div>
                    </div>
                     <hr>
                    <div>
                        <h2 class="section-title">Lançamentos de Fibra</h2>
                        <div id="fiber-runs-container" class="space-y-4"></div>
                        <div class="flex justify-center mt-4">
                            <button onclick="addFiberRun()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Adicionar Lançamento
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-b border-gray-200 mt-8 no-print">
                <nav class="-mb-px flex justify-center space-x-4" aria-label="Tabs">
                    <button id="tab-desbalanceada" onclick="switchTab('desbalanceada')" class="tab-button tab-active">Rede Desbalanceada</button>
                    <button id="tab-balanceada" onclick="switchTab('balanceada')" class="tab-button">Rede Balanceada</button>
                </nav>
            </div>

            <div id="tab-panel-desbalanceada" class="tab-panel printable-area">
                <div class="section-card">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Parâmetros da Rede Desbalanceada</h2>
                     <div class="max-w-md mx-auto mb-6">
                         <label for="map-link-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                         <div class="flex items-center">
                             <input id="map-link-input-unbalanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                             <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                             </button>
                         </div>
                    </div>
                     <div class="max-w-xs mx-auto mb-6">
                        <label for="olt-power-input-unbalanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                        <div class="flex items-center">
                            <input type="text" id="olt-power-input-unbalanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                            <span class="font-semibold text-gray-700 ml-2">dBm</span>
                        </div>
                    </div>
                    <div id="network-layout-container" class="flex flex-wrap justify-center gap-4">
                        </div>
                    <div class="flex flex-wrap justify-center mt-6 gap-4">
                         <button onclick="addSpliceBox()" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01M12 6v12" />
                            </svg>
                            + Caixa de Emenda
                        </button>
                        <button onclick="addCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            + CTO
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="tab-panel-balanceada" class="hidden tab-panel printable-area">
                 <div class="section-card">
                    <h2 class="text-2xl font-bold text-center text-gray-700 mb-6">Parâmetros da Rede Balanceada</h2>
                    <div class="max-w-md mx-auto mb-6">
                         <label for="map-link-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Link do Mapa (Google My Maps)</label>
                         <div class="flex items-center">
                             <input id="map-link-input-balanced" oninput="handleMapLinkChange(this)" type="url" placeholder="Cole o link compartilhável do seu mapa aqui" class="w-full p-2 rounded-l-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                             <button onclick="viewProjectMap()" title="Visualizar Mapa" class="bg-blue-600 text-white p-3 rounded-r-md hover:bg-blue-700 transition no-print">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.527-1.912 6.01 6.01 0 012.142 4.072 6.01 6.01 0 01-3.668 5.473 1.503 1.503 0 01-1.499.044 2 2 0 00-2.427 0 2 2 0 01-1.527 1.912 6.01 6.01 0 01-3.8-5.57z" clip-rule="evenodd" /></svg>
                             </button>
                         </div>
                    </div>
                     <div class="max-w-xs mx-auto mb-6">
                        <label for="olt-power-input-balanced" class="font-bold text-lg text-gray-600 text-center block mb-2">Potência OLT</label>
                        <div class="flex items-center">
                            <input type="text" id="olt-power-input-balanced" oninput="handleOltPowerChange(this)" value="7.00" class="w-full p-2 text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"/>
                            <span class="font-semibold text-gray-700 ml-2">dBm</span>
                        </div>
                    </div>
                    <div class="max-w-4xl mx-auto grid grid-cols-1 gap-6 bg-gray-50 p-4 rounded-lg border mb-6">
                        <div class="flex flex-col items-center">
                            <label for="balanced-primary-splitter" class="font-bold text-lg text-gray-600">Splitter Primário (CEOA)</label>
                            <select id="balanced-primary-splitter" onchange="handleBalancedConfigChange('primarySplitter', this.value)" class="mt-1 w-full max-w-xs text-center p-2 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500"></select>
                        </div>
                    </div>
                     <div id="balanced-network-container" class="flex flex-wrap justify-center gap-4">
                         </div>
                     <div class="flex flex-wrap justify-center mt-6 gap-4">
                         <button onclick="addBalancedSpliceBox()" class="bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01M12 6v12"></path>
                            </svg>
                            + CEO/CDR
                        </button>
                         <button onclick="addBalancedCto()" class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 px-5 rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                             + CTO
                         </button>
                     </div>
                 </div>
            </div>

            <div class="section-card printable-area">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Lista de Materiais e Orçamento</h2>
                <p class="text-center text-sm text-gray-500 mb-4">A lista é calculada com base na aba de rede que está ativa (<span id="active-network-label" class="font-bold"></span>).</p>
                <div class="max-w-4xl mx-auto">
                    <table class="w-full text-sm" id="materials-table"></table>
                </div>
                 <div id="materials-calculation-details" class="max-w-4xl mx-auto mt-6"></div>
            </div>
        </div>
    </div>
    
    <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 text-left" id="modal-title"></h3>
                <div class="mt-4">
                    <p class="text-md text-gray-600 text-left whitespace-pre-line" id="modal-content"></p>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-4 flex justify-end gap-3 rounded-b-lg">
                <button id="ok-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal da Calculadora -->
    <div id="calculatorModal" class="no-print hidden fixed z-50 left-0 top-0 w-full h-full bg-black/50 justify-center items-center" style="display: none;">
        <div class="bg-gray-200 p-4 rounded-lg shadow-xl w-full max-w-xs">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Calculadora</h2>
                <button id="closeCalcModalBtn" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="calc-display" class="bg-white text-right p-2 rounded mb-2 text-3xl font-mono break-all">0</div>
            <div class="grid grid-cols-4 gap-2 text-lg">
                <button data-value="clear" class="calc-btn bg-red-500 hover:bg-red-600 text-white">C</button>
                <button data-value="/" class="calc-btn bg-gray-400 hover:bg-gray-500 text-white">/</button>
                <button data-value="*" class="calc-btn bg-gray-400 hover:bg-gray-500 text-white">*</button>
                <button data-value="-" class="calc-btn bg-gray-400 hover:bg-gray-500 text-white">-</button>
                
                <button data-value="7" class="calc-btn bg-white hover:bg-gray-100">7</button>
                <button data-value="8" class="calc-btn bg-white hover:bg-gray-100">8</button>
                <button data-value="9" class="calc-btn bg-white hover:bg-gray-100">9</button>
                <button data-value="+" class="calc-btn bg-gray-400 hover:bg-gray-500 text-white row-span-2">+</button>

                <button data-value="4" class="calc-btn bg-white hover:bg-gray-100">4</button>
                <button data-value="5" class="calc-btn bg-white hover:bg-gray-100">5</button>
                <button data-value="6" class="calc-btn bg-white hover:bg-gray-100">6</button>

                <button data-value="1" class="calc-btn bg-white hover:bg-gray-100">1</button>
                <button data-value="2" class="calc-btn bg-white hover:bg-gray-100">2</button>
                <button data-value="3" class="calc-btn bg-white hover:bg-gray-100">3</button>
                <button data-value="=" class="calc-btn bg-blue-500 hover:bg-blue-600 text-white row-span-2">=</button>

                <button data-value="0" class="calc-btn bg-white hover:bg-gray-100 col-span-2">0</button>
                <button data-value="." class="calc-btn bg-white hover:bg-gray-100">.</button>
            </div>
        </div>
    </div>

    <!-- Modal da Previsão do Tempo -->
    <div id="weatherModal" class="no-print hidden fixed z-50 left-0 top-0 w-full h-full bg-black/50 justify-center items-center" style="display: none;">
         <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Previsão do Tempo</h2>
                <button id="closeWeatherModalBtn" class="text-2xl font-bold">&times;</button>
            </div>
            <!-- Widget de Clima -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner w-full">
                <div id="weatherWidget" class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-3">
                        <div id="weatherIcon" class="w-16 h-16 rounded-md flex items-center justify-center text-5xl"></div>
                        <div>
                            <div id="weatherTemp" class="font-bold text-2xl">--° / --°</div>
                            <div id="weatherCity" class="text-md text-gray-600">Carregando...</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="cityInput" placeholder="Mudar cidade" class="p-2 border rounded-md text-sm w-32">
                        <button id="updateWeatherBtn" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 text-sm h-full px-3">OK</button>
                    </div>
                </div>
                <!-- Previsão para os próximos dias -->
                <div id="weatherForecast" class="flex justify-between space-x-2 mt-4 w-full">
                    <!-- A previsão será inserida aqui via JavaScript -->
                </div>
            </div>
         </div>
    </div>

    <footer class="mt-8 pt-8 border-t border-gray-200 text-center text-gray-600 no-print">
        <div class="max-w-2xl mx-auto">
            <h3 class="text-xl font-bold text-gray-800">Suporte e Contato</h3>
            <p class="mt-4 font-semibold">Para dúvidas ou sugestões, entre em contato:</p>
            <a href="https://wa.me/5575998312170" target="_blank" class="mt-2 inline-flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors shadow-md">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.152,4.26C8.24,4.26,6.65,5.85,6.65,7.761c0,0.619,0.161,1.196,0.446,1.714L6.92,9.88l-0.565,1.977l2.03-0.555	C8.75,11.536,9.423,11.69,10.152,11.69c1.91,0,3.5-1.59,3.5-3.5S12.062,4.26,10.152,4.26z M15.654,14.188	c-0.326-0.164-1.932-0.951-2.232-1.062s-0.519-0.164-0.739,0.164s-0.843,1.062-1.033,1.282s-0.38,0.246-0.705,0.082	s-1.378-0.506-2.624-1.619s-1.958-2.26-2.193-2.646s-0.246-0.58,0.156-0.744c0.094-0.037,0.203-0.09,0.301-0.136	c0.237-0.113,0.312-0.188,0.402-0.313c0.113-0.15,0.168-0.281,0.249-0.459c0.082-0.178,0.041-0.329-0.021-0.492	c-0.062-0.164-0.657-1.583-0.9-2.166c-0.237-0.564-0.485-0.485-0.657-0.492c-0.164-0.01-0.348-0.01-0.533-0.01	c-0.185,0-0.485,0.082-0.739,0.41s-0.9,0.884-0.9,2.144s0.923,2.481,1.053,2.646s1.82,2.777,4.416,3.91	c2.596,1.133,2.596,0.754,3.056,0.732c0.46-0.021,1.523-0.621,1.739-1.22c0.216-0.598,0.216-1.107,0.156-1.22	C16.151,14.398,15.98,14.352,15.654,14.188z M10.001,0C4.486,0,0,4.486,0,10.001c0,5.514,4.486,10,10.001,10	c5.514,0,10-4.486,10-10.001C20.001,4.486,15.515,0,10.001,0z M10.001,18.13c-4.48,0-8.128-3.649-8.128-8.129	c0-4.48,3.649-8.128,8.128-8.128c4.48,0,8.129,3.649,8.129,8.128C18.13,14.481,14.481,18.13,10.001,18.13z"/></svg>
                Chamar no WhatsApp: +55 75 99831-2170
            </a>
            <p class="mt-6 text-sm text-gray-500">Desenvolvido por Jânio Carlos 10/08/2025</p>
        </div>
    </footer>


    <script id="main-logic-script">
        // --- Lógica para o novo menu de ferramentas ---
        function toggleMenu() {
            const dropdown = document.getElementById('main-menu-dropdown');
            dropdown.classList.toggle('hidden');
        }

        // Fecha o menu se o usuário clicar fora dele
        window.addEventListener('click', function(event) {
            const dropdown = document.getElementById('main-menu-dropdown');
            const button = document.getElementById('menu-button');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                if (button && !button.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            }
        });


        // --- Variáveis de Estado Globais ---
        let oltPower = 7.00;
        let projectName = '';
        let technicianName = '';
        let googleMapsUrl = '';
        let oltPortNumber = '';
        let dioGroup = '';
        let fiberColor = '';
        let fiberRuns = [{ type: 'Fibra Óptica 12 FO', length: 0 }];
        let manualMaterials = {};
        let materialPrices = {};
        let activeTab = 'desbalanceada';
        let networkSegments = [];
        let balancedConfig = { primarySplitter: '1:8' };
        let balancedNetworkCtos = [];
        const FIBER_LOSS_PER_KM = 0.10;
        const FUSION_SPLICE_LOSS = 0.10;
        let debounceTimer = null;
        let saveTimeout;
        let customMaterials = [];
        let manualMaterialNames = {};
        

        const FIBER_COLORS = [
            { name: 'Verde', hex: '#28a745', text: 'white' }, { name: 'Amarelo', hex: '#ffc107', text: 'black' },
            { name: 'Branco', hex: '#ffffff', text: 'black' }, { name: 'Azul', hex: '#007bff', text: 'white' },
            { name: 'Vermelho', hex: '#dc3545', text: 'white' }, { name: 'Violeta', hex: '#6f42c1', text: 'white' },
            { name: 'Marrom', hex: '#a52a2a', text: 'white' }, { name: 'Rosa', hex: '#e83e8c', text: 'white' },
            { name: 'Preto', hex: '#000000', text: 'white' }, { name: 'Cinza', hex: '#6c757d', text: 'white' },
            { name: 'Laranja', hex: '#fd7e14', text: 'white' }, { name: 'Aqua', hex: '#00ffff', text: 'black' }
        ];
    
        const UNBALANCED_CTO_ROWS = [
          { label: 'Sinal Entrada', key: 'sinalEntradaHub', type: 'result' },
          { label: 'Splitter Desb.', key: 'splitterHub', type: 'select_hub' },
          { label: 'Perda Passagem', key: 'perdaPassagemHub', type: 'result_detail' },
          { label: 'Sinal Saída', key: 'sinalSaidaHub', type: 'result' },
          { label: 'Perda Trecho', key: 'perdaTotalTrecho', type: 'result_detail' },
          { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
          { label: 'Sinal Final CTO', key: 'sinalFinalCto', type: 'result_final' },
        ];
        
        const UNBALANCED_SPLICE_BOX_ROWS = [];
        
        const splitterLosses = { 
          'Ausente': { drop: 0, pass: 0 }, '1:2': { drop: 3.7 }, '1:4': { drop: 7.1 }, '1:8': { drop: 10.5 }, '1:16': { drop: 13.7 }, '1:32': { drop: 17.1 }, '1:64': { drop: 20.4 }, '1:128': { drop: 23.9 }, 
          '1:99': { drop: 21.6, pass: 0.3 }, '2:98': { drop: 18.7, pass: 0.4 }, '3:97': { drop: 16.8, pass: 0.4 }, '4:96': { drop: 14.9, pass: 0.4 }, '5:95': { drop: 14.6, pass: 0.5 }, '7:93': { drop: 13.0, pass: 0.6 }, '9:91': { drop: 11.7, pass: 0.65 }, '10:90': { drop: 11.0, pass: 0.7 }, '15:85': { drop: 9.6,  pass: 1.0 }, '20:80': { drop: 7.9,  pass: 1.4 }, '25:75': { drop: 6.95, pass: 1.7 }, '30:70': { drop: 6.0,  pass: 1.9 }, '35:65': { drop: 5.35, pass: 2.3 }, '40:60': { drop: 4.7,  pass: 2.7 }, '45:55': { drop: 4.15, pass: 3.15 }, '50:50': { drop: 3.7,  pass: 2.5 },
        };
        
        function getSignalColorClass(signal) { if (isNaN(signal) || signal === null) return 'bg-gray-100 border-gray-300 text-gray-500'; if (signal < -22) return 'signal-bad'; if (signal < -19) return 'signal-warn'; return 'signal-good'; }
        
        function getSplitterOptions(type, selectedValue) { 
            let list;
            if (type === 'hub') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass !== undefined);
            } else if (type === 'balanced') {
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined && k !== 'Ausente');
            } else { // cto
                list = Object.keys(splitterLosses).filter(k => splitterLosses[k].pass === undefined || k === 'Ausente');
            }
            return list.map(key => `<option value="${key}" ${key === selectedValue ? 'selected' : ''}>${key}</option>`).join('');
        }

        function switchTab(tabName) {
            activeTab = tabName;
            const tabs = ['desbalanceada', 'balanceada'];
            tabs.forEach(tab => {
                document.getElementById(`tab-panel-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });
            document.getElementById(`tab-panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            triggerAutoSave();
            updateMaterialsList();
        }

        function showModal(title, content) {
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            if(modal) {
                modalTitle.innerText = title;
                modalContent.innerText = content;
                modal.classList.remove('hidden');

                const okBtn = document.getElementById('ok-btn');
                okBtn.onclick = () => modal.classList.add('hidden');
            }
        }

        function handleDescriptionChange(event, index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[index]) {
                network[index].description = event.target.innerText.trim();
                const card = event.target.closest('.cto-card-print');
                if(card){
                    const printableDesc = card.querySelector('.printable-only-description span:last-child');
                    if(printableDesc) {
                        printableDesc.textContent = network[index].description || 'N/A';
                    }
                }
                triggerAutoSave();
            }
        }

        function renderUnbalancedNetwork() {
            const container = document.getElementById('network-layout-container');
            container.innerHTML = ''; 
            let ctoCounter = 0;
            let spliceBoxCounter = 0;
            networkSegments.forEach((segment, index) => {
                let displayIndex;
                if(segment.type === 'splice_box'){
                    spliceBoxCounter++;
                    displayIndex = spliceBoxCounter;
                } else {
                    ctoCounter++;
                    displayIndex = ctoCounter;
                }
                const networkCard = createNetworkCard(segment, index, 'unbalanced', displayIndex);
                container.appendChild(networkCard);
            });
        }
        
        function renderBalancedNetwork() {
            const container = document.getElementById('balanced-network-container');
            container.innerHTML = '';
            document.getElementById('balanced-primary-splitter').innerHTML = getSplitterOptions('balanced', balancedConfig.primarySplitter);
            
            let ctoCounter = 0;
            let spliceBoxCounter = 0;

            balancedNetworkCtos.forEach((item, index) => {
                let displayIndex;
                if (item.type === 'splice_box') {
                    spliceBoxCounter++;
                    displayIndex = spliceBoxCounter;
                } else {
                    ctoCounter++;
                    displayIndex = ctoCounter;
                }
                const card = createNetworkCard(item, index, 'balanced', displayIndex);
                container.appendChild(card);
            });
        }

        function createNetworkCard(data, index, networkType, displayIndex) {
            const isUnbalanced = networkType === 'unbalanced';
            const isSpliceBox = data.type === 'splice_box';
            const geoText = data.geo ? `${data.geo.lat.toFixed(5)}, ${data.geo.lon.toFixed(5)}` : 'N/A';
            const cardIdPrefix = isUnbalanced ? 'U' : 'B';
            
            let title = '';
            const finalIndex = displayIndex || index + 1;

            if (isSpliceBox) {
                title = `CEO/CDR-${String(finalIndex).padStart(2, '0')}`;
            } else if (isUnbalanced) {
                title = `CTO-${String(finalIndex).padStart(2, '0')}`;
            } else { // Balanced CTOs
                title = `CTO Bal.-${String(finalIndex).padStart(2, '0')}`;
            }

            const selectedColor = FIBER_COLORS[data.colorGroup || 0];
            
            const card = document.createElement('div');
            card.className = "cto-card-print flex flex-col items-center bg-gray-50 rounded-lg shadow-md border p-3";
            card.style.width = "280px";
            
            let removeAction = '';
            if(isUnbalanced) {
                removeAction = `removeNetworkSegment(${index})`;
            } else {
                removeAction = `removeBalancedItem(${index})`;
            }

            let cardHtml = `
            <h3 class="relative text-lg font-bold mb-3 px-4 py-1 rounded-full border border-gray-300" 
                 style="background-color:${selectedColor.hex}; color:${selectedColor.text};">
                ${title}
                <button onclick="${removeAction}" title="Remover" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors no-print"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </h3>
            <div class="flex flex-col items-center mb-2 w-full">
                <span class="text-xs font-semibold text-gray-600">Geolocalização:</span>
                <span class="text-xs text-gray-500 mt-1 printable-geo">${geoText}</span>
                <div class="flex gap-1 mt-1">
                    <button onclick="getGeoLocation(${index}, '${networkType}')" class="geo-button bg-blue-500 text-white hover:bg-blue-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> GPS</button>
                    <button onclick="copyGeoLocation(${index}, '${networkType}')" class="geo-button bg-gray-500 text-white hover:bg-gray-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg> Copiar</button>
                    <button onclick="openInGoogleMaps(${index}, '${networkType}')" class="geo-button bg-green-500 text-white hover:bg-green-600 no-print flex-1 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg> Mapa</button>
                </div>
                <div class="flex items-center mt-2 w-full">
                    <input id="manual-geo-input-${cardIdPrefix}-${index}" type="text" placeholder="Inserir Coords." class="w-full text-center text-xs p-1 rounded-l-md border-2 border-gray-300 focus:border-indigo-500">
                    <button onclick="saveManualGeo(${index}, '${networkType}')" class="bg-indigo-500 text-white text-xs font-bold p-1.5 rounded-r-md hover:bg-indigo-600 transition">Salvar</button>
                </div>
            </div>
             <div class="flex items-center justify-start w-full mb-1.5 px-2 gap-4">
                <div class="flex items-center">
                    <label class="text-xs font-semibold text-gray-600 mr-1">Dist(m):</label>
                    <input id="cto-${cardIdPrefix}-${index}-distance" type="number" value="${data.distance || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'distance')" class="input-field !w-16" />
                </div>
                <div class="flex items-center">
                    <label class="text-xs font-semibold text-gray-600 mr-1">${isSpliceBox ? 'Fusões:' : 'Fusões:'}</label>
                    <input id="cto-${cardIdPrefix}-${index}-spliceCount" type="number" value="${data.spliceCount || 0}" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'spliceCount')" class="input-field !w-12" />
                </div>
            </div>
            `;
            
            if (isSpliceBox) {
                 cardHtml += `<div id="splice-details-${index}" class="w-full mt-2 pt-2 border-t border-gray-300">
                    <div class="text-xs font-semibold text-gray-600 text-center mb-1">Detalhes da Fusão (Cor a Cor)</div>`;
                (data.spliceDetails || []).forEach((detail, detailIndex) => {
                    const color1 = FIBER_COLORS[detail.color1 || 0];
                    const color2 = FIBER_COLORS[detail.color2 || 0];
                    cardHtml += `
                    <div class="flex items-center justify-between w-full mb-1 px-2 gap-1">
                        <select oninput="handleSpliceDetailChange(event, ${index}, ${detailIndex}, 'color1', '${networkType}')" class="input-field flex-1 font-semibold" style="background-color:${color1.hex}; color:${color1.text}; border-color: #999;">
                            ${FIBER_COLORS.map((c, i) => `<option value="${i}" ${i === (detail.color1 || 0) ? 'selected' : ''} style="background-color:${c.hex}; color:${c.text};">${c.name}</option>`).join('')}
                        </select>
                        <span class="text-xs font-bold">X</span>
                        <select oninput="handleSpliceDetailChange(event, ${index}, ${detailIndex}, 'color2', '${networkType}')" class="input-field flex-1 font-semibold" style="background-color:${color2.hex}; color:${color2.text}; border-color: #999;">
                             ${FIBER_COLORS.map((c, i) => `<option value="${i}" ${i === (detail.color2 || 0) ? 'selected' : ''} style="background-color:${c.hex}; color:${c.text};">${c.name}</option>`).join('')}
                        </select>
                        <button onclick="removeSpliceDetail(${index}, ${detailIndex}, '${networkType}')" class="p-1 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    `;
                });
                cardHtml += `<button onclick="addSpliceDetail(${index}, '${networkType}')" class="mt-1 w-full text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded-md transition">+ Adicionar Fusão</button></div>`;
            } else {
                cardHtml += `
                <div class="flex items-center w-full mb-1.5 px-2">
                    <label class="flex-1 text-xs font-semibold text-gray-600">Cor da Fibra:</label>
                    <select id="cto-${cardIdPrefix}-${index}-colorGroup" oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'colorGroup')" class="input-field font-semibold" style="background-color:${selectedColor.hex}; color:${selectedColor.text}; border-color: #999;">
                        ${FIBER_COLORS.map((color, colorIndex) => `<option value="${colorIndex}" ${colorIndex === (data.colorGroup || 0) ? 'selected' : ''} style="background-color:${color.hex}; color:${color.text};">${colorIndex + 1} - ${color.name}</option>`).join('')}
                    </select>
                </div>`;
            }

            cardHtml += `<div class="w-full">`;
            
            let parameterRows = [];
            if (isUnbalanced) {
                parameterRows = isSpliceBox ? UNBALANCED_SPLICE_BOX_ROWS : UNBALANCED_CTO_ROWS;
            } else { // Rede Balanceada
                if (!isSpliceBox) { // Apenas para CTOs balanceados
                    parameterRows = [
                        { label: 'Splitter CTO', key: 'splitterCto', type: 'select_cto' },
                        { label: 'Sinal Final CTO', key: 'sinalFinal', type: 'result_final' }
                    ];
                }
            }
            
            parameterRows.forEach(row => {
                const value = data[row.key];
                if (row.type === 'result_final') {
                    const finalSignal = parseFloat(value);
                    const colorClass = getSignalColorClass(finalSignal);
                    cardHtml += `<div class="flex justify-between items-center w-full mb-1.5 px-2"><label class="text-xs font-semibold text-gray-600">${row.label}:</label><div class="px-3 py-1 text-sm font-bold rounded-full ${colorClass}">${value || '---'} dBm</div></div>`;
                } else {
                    cardHtml += `<div class="flex items-center w-full mb-1.5 px-2"><label class="flex-1 text-xs font-semibold text-gray-600">${row.label}:</label>`;
                    switch(row.type) {
                        case 'select_hub': cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterHub')" class="input-field">${getSplitterOptions('hub', data.splitterHub)}</select>`; break;
                        case 'select_cto':
                             const optionsType = isUnbalanced ? 'cto' : 'balanced';
                             cardHtml += `<select oninput="handleCtoDataChange(event, ${index}, '${networkType}', 'splitterCto')" class="input-field">${getSplitterOptions(optionsType, data.splitterCto)}</select>`;
                             break;
                        case 'result': cardHtml += `<input type="text" value="${value || '---'}" readonly class="result-field" />`; break;
                        case 'result_detail': cardHtml += `<div class="loss-detail">${value || '---'}</div>`; break;
                    }
                    cardHtml += `</div>`;
                }
            });
            
            cardHtml += `
            <div class="mt-2 w-full text-center">
                <div class="text-xs text-gray-500 font-bold mb-1">Descrição</div>
                <div onblur="handleDescriptionChange(event, ${index}, '${networkType}')" contenteditable="true" data-placeholder="Clique para editar..." class="manual-signal-field no-print text-gray-700 not-italic border border-gray-300 rounded-md p-1 min-h-[40px] bg-white">${data.description || ''}</div>
                <div class="printable-only-description"><span class="text-xs font-bold text-gray-700">Descrição: </span><span>${data.description || 'N/A'}</span></div>
            </div>
            </div>`;
            card.innerHTML = cardHtml;
            return card;
        }
    
        function updateMaterialsList() {
            document.getElementById('active-network-label').textContent = activeTab === 'desbalanceada' ? 'Desbalanceada' : 'Balanceada';
            const table = document.getElementById('materials-table');
            let html = `<thead class="bg-gray-100"><tr><th class="py-2 px-1 text-left">Item</th><th class="py-2 px-1 text-center">Valor</th><th class="py-2 px-1 text-center">Qtde.</th><th class="py-2 px-1 text-right">Subt.</th><th class="w-8"></th></tr></thead><tbody>`;
            let grandTotal = 0;
            
            let ctoCount = 0;
            let spliceBoxCount = 0;
            const hubSplitterCounts = {}, ctoSplitterCounts = {};
            let totalAcopladores = 0;

            if (activeTab === 'desbalanceada') {
                networkSegments.forEach(seg => {
                    const type = seg.type || 'cto';
                    
                    if(type === 'splice_box') {
                        spliceBoxCount++;
                    } else {
                        ctoCount++;
                    }

                    if (seg.splitterHub && seg.splitterHub !== 'Ausente') { 
                        hubSplitterCounts[seg.splitterHub] = (hubSplitterCounts[seg.splitterHub] || 0) + 1; 
                    }
                    if (type === 'cto' && seg.splitterCto && seg.splitterCto !== 'Ausente') { 
                        ctoSplitterCounts[seg.splitterCto] = (ctoSplitterCounts[seg.splitterCto] || 0) + 1; 
                        const parts = seg.splitterCto.split(':');
                        if (parts.length === 2) { totalAcopladores += parseInt(parts[1], 10) || 0; }
                    }
                });
            } else { // Rede Balanceada
                balancedNetworkCtos.forEach(item => {
                    if (item.type === 'splice_box') {
                        spliceBoxCount++;
                    } else {
                        ctoCount++;
                        if (item.splitterCto) {
                            ctoSplitterCounts[item.splitterCto] = (ctoSplitterCounts[item.splitterCto] || 0) + 1;
                            const parts = item.splitterCto.split(':');
                            if (parts.length === 2) { totalAcopladores += parseInt(parts[1], 10) || 0; }
                        }
                    }
                });
                if (balancedConfig.primarySplitter) {
                     hubSplitterCounts[balancedConfig.primarySplitter] = 1;
                }
            }
            
            const fiberTotals = {};
            fiberRuns.forEach(run => {
                if (!fiberTotals[run.type]) { fiberTotals[run.type] = 0; }
                fiberTotals[run.type] += run.length || 0;
            });

            const fiberMaterialItems = Object.keys(fiberTotals).map(type => ({
                id: `cabo_${type.replace(/[^a-z0-9]/gi, '_')}`,
                name: `${type} (Lançada)`,
                qty: `${fiberTotals[type]} m`,
                numericQty: fiberTotals[type],
                editable: false,
            }));

            const poleCount = fiberRuns.reduce((sum, run) => sum + run.length, 0) > 0 ? Math.ceil(fiberRuns.reduce((sum, run) => sum + run.length, 0) / 43) : 0;
            const dropFiberPerCto = ctoCount * 16;

            const otherMaterials = [
                { id: 'caixa_emenda_ceo', name: 'Caixa de Emenda (CEO/CDR)', qty: spliceBoxCount, numericQty: spliceBoxCount, editable: true },
                { id: 'cto_total', name: 'Total de CTOs', qty: ctoCount, numericQty: ctoCount, editable: false },
                { id: 'fibra_drop_cto', name: 'Fibra Atendimento (16m/CTO)', qty: `${dropFiberPerCto} m`, numericQty: dropFiberPerCto, editable: false },
                ...Object.entries(hubSplitterCounts).map(([name, count]) => ({ id: `hub_${name.replace(/[^a-zA-Z0-9]/g, '')}`, name: `Splitter ${activeTab === 'balanceada' ? 'Primário' : 'Desb.'} ${name}`, qty: count, numericQty: count, editable: false })), 
                ...Object.entries(ctoSplitterCounts).map(([name, count]) => ({ id: `cto_${name.replace(/[^a-zA-Z0-9]/g, '')}`, name: `Splitter de CTO ${name}`, qty: count, numericQty: count, editable: false })), 
                { id: 'acoplador', name: 'Acoplador Óptico SC/APC', qty: totalAcopladores, numericQty: totalAcopladores, editable: false },
                { id: 'bap', name: 'Braçadeira BAP', qty: poleCount, numericQty: poleCount, editable: true }, 
                { id: 'supa', name: 'Suporte (SUPA)', qty: poleCount, numericQty: poleCount, editable: true }, 
                { id: 'alca', name: 'Alça Preformada', qty: poleCount * 2, numericQty: poleCount * 2, editable: true }, 
                { id: 'roldana', name: 'Roldana', qty: 0, numericQty: 0, editable: true, manual: true }
            ];
            
            let materialsHtml = '';
            
            const allStaticMaterials = [...fiberMaterialItems, ...otherMaterials];
            allStaticMaterials.forEach(item => {
                const unitPrice = materialPrices[item.id] || 0;
                let itemQty = item.editable ? (manualMaterials[item.id] !== undefined ? parseInt(manualMaterials[item.id], 10) || 0 : item.numericQty) : item.numericQty;
                
                 if(item.manual) itemQty = manualMaterials[item.id] || 0;
                
                const subtotal = itemQty * unitPrice;
                grandTotal += subtotal;

                const qtyDisplay = item.qty.toString().includes('m') ? item.qty : itemQty;

                materialsHtml += `<tr class="border-b">
                    <td class="py-2 px-1 font-semibold align-middle">${item.name}</td>
                    <td class="py-2 px-1 align-middle text-center">
                        <input type="text" id="price-${item.id}" oninput="saveMaterialPrice(event, '${item.id}', this.value)" value="${unitPrice > 0 ? unitPrice.toFixed(2).replace('.', ',') : ''}" placeholder="0,00" class="w-16 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">
                    </td>
                    <td class="py-2 px-1 text-center align-middle">`;

                if (item.editable) {
                    const onInputHandler = `oninput="saveManualMaterial(event, '${item.id}', this.value)"`;
                    let qtyValue = manualMaterials[item.id] !== undefined ? manualMaterials[item.id] : item.qty;
                     if(item.manual) qtyValue = manualMaterials[item.id] || 0;

                    materialsHtml += `<input type="number" id="input-${item.id}" value="${qtyValue}" ${onInputHandler} class="w-12 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">`;
                } else {
                    materialsHtml += `<span class="font-bold text-lg">${qtyDisplay}</span>`;
                }
                
                materialsHtml += `</td>
                    <td class="py-2 px-1 text-right align-middle font-bold">${subtotal.toFixed(2).replace('.',',')}</td>
                    <td></td>
                </tr>`;
            });
            
            customMaterials.forEach((item, index) => {
                const subtotal = (item.qty || 0) * (item.price || 0);
                grandTotal += subtotal;

                materialsHtml += `<tr class="border-b">
                    <td class="py-2 px-1 font-semibold align-middle" contenteditable="true" onblur="handleCustomMaterialChange(event, ${index}, 'name')">${item.name}</td>
                    <td class="py-2 px-1 align-middle text-center">
                        <input type="text" value="${(item.price || 0).toFixed(2).replace('.', ',')}" oninput="handleCustomMaterialChange(event, ${index}, 'price')" placeholder="0,00" class="w-16 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">
                    </td>
                    <td class="py-2 px-1 text-center align-middle">
                        <input type="number" value="${item.qty || 0}" oninput="handleCustomMaterialChange(event, ${index}, 'qty')" class="w-12 text-center font-bold p-1 border rounded bg-gray-50 focus:bg-white">
                    </td>
                    <td class="py-2 px-1 text-right align-middle font-bold">${subtotal.toFixed(2).replace('.',',')}</td>
                    <td class="py-2 px-1 text-center align-middle">
                        <button onclick="removeCustomMaterial(${index})" class="p-1 text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </td>
                </tr>`;
            });


            html += materialsHtml;
            html += `</tbody>
                <tfoot class="bg-gray-100 font-bold">
                    <tr>
                        <td colspan="4" class="py-3 px-2 text-right text-lg">Custo Total:</td>
                        <td class="py-3 px-2 text-right text-lg">${grandTotal.toFixed(2).replace('.',',')}</td>
                    </tr>
                </tfoot>`;
            table.innerHTML = html;

            const tableContainer = table.parentElement;
            let addButton = document.getElementById('add-custom-material-btn');
            if (!addButton) {
                addButton = document.createElement('button');
                addButton.id = 'add-custom-material-btn';
                addButton.textContent = '+ Adicionar Item';
                addButton.className = 'mt-4 bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300';
                addButton.onclick = addCustomMaterial;
                tableContainer.appendChild(addButton);
            }

            const detailsContainer = document.getElementById('materials-calculation-details');
            detailsContainer.innerHTML = `
                <h3 class="text-xl font-bold text-center text-gray-700 mb-4 border-t pt-4">Memória de Cálculo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600">Total de Fibra Lançada:</span>
                        <span class="font-bold text-gray-800">${fiberRuns.reduce((sum, run) => sum + run.length, 0).toFixed(0)} m</span>
                    </div>
                    <div class="flex justify-between border-b pb-1">
                        <span class="font-semibold text-gray-600">Total de Postes (1 a cada 43m):</span>
                        <span class="font-bold text-gray-800">${poleCount}</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 md:col-span-2">
                        <span class="font-semibold text-gray-600">Folga de Segurança (5% por tipo de cabo):</span>
                        <span class="font-bold text-gray-800">Calculado individualmente</span>
                    </div>
                </div>
            `;
        }
    
        function recalculateUnbalanced() {
            let powerForNextSegment = oltPower;
            
            networkSegments.forEach((segment) => {
                const distanceInKm = (segment.distance || 0) / 1000;
                let fusionLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;

                if (segment.type === 'splice_box') {
                    fusionLoss = (segment.spliceDetails?.length || 0) * FUSION_SPLICE_LOSS;
                }
                
                const totalSegmentLoss = (distanceInKm * FIBER_LOSS_PER_KM) + fusionLoss;
                segment.perdaTotalTrecho = totalSegmentLoss.toFixed(2) + ' dB';

                const sinalEntradaHub = powerForNextSegment - totalSegmentLoss;
                segment.sinalEntradaHub = sinalEntradaHub.toFixed(2);
                
                const hubSplitter = splitterLosses[segment.splitterHub] || { drop: 0, pass: 0 };
                const ctoSplitter = splitterLosses[segment.splitterCto] || { drop: 0 };
                
                segment.perdaPassagemHub = (hubSplitter.pass || 0).toFixed(2) + ' dB';
                
                const sinalFinalCto = sinalEntradaHub - hubSplitter.drop - ctoSplitter.drop;

                if (segment.type !== 'splice_box') {
                    segment.sinalFinalCto = (segment.splitterCto === 'Ausente') ? null : sinalFinalCto.toFixed(2);
                } else {
                    segment.sinalFinalCto = null;
                }
                
                const sinalSaidaHub = sinalEntradaHub - hubSplitter.pass;
                segment.sinalSaidaHub = sinalSaidaHub.toFixed(2);
                
                powerForNextSegment = sinalSaidaHub;
            });
            renderUnbalancedNetwork();
            updateMaterialsList();
        }

        function recalculateBalanced() {
            // A potência após o splitter primário é o ponto de partida para a cadeia secundária.
            let powerForChain = oltPower - (splitterLosses[balancedConfig.primarySplitter]?.drop || 0);

            balancedNetworkCtos.forEach(segment => {
                // A potência que chega a este segmento é a potência atual da cadeia
                const inputPower = powerForChain;
                const distanceLoss = ((segment.distance || 0) / 1000) * FIBER_LOSS_PER_KM;

                if (segment.type === 'splice_box') {
                    const fusionLoss = (segment.spliceDetails?.length || 0) * FUSION_SPLICE_LOSS;
                    segment.sinalFinal = null; // Caixas de emenda não têm sinal final de cliente
                    // Atualiza a potência para o próximo elemento na cadeia
                    powerForChain = inputPower - distanceLoss - fusionLoss;
                } else { // É uma CTO
                    const spliceLoss = (segment.spliceCount || 0) * FUSION_SPLICE_LOSS;
                    const secondarySplitterLoss = splitterLosses[segment.splitterCto]?.drop || 0;
                    const finalSignal = inputPower - distanceLoss - spliceLoss - secondarySplitterLoss;
                    segment.sinalFinal = finalSignal.toFixed(2);
                    // Uma CTO é um ponto final nesta topologia, então a potência para o resto da cadeia é interrompida.
                    powerForChain = -Infinity;
                }
            });

            renderBalancedNetwork();
            updateMaterialsList();
        }
        
        function updateUIWithLoadedData() {
            document.getElementById('project-name-input').value = projectName;
            document.getElementById('technician-name-input').value = technicianName;
            
            document.getElementById('olt-power-input-unbalanced').value = oltPower.toFixed(2);
            document.getElementById('olt-power-input-balanced').value = oltPower.toFixed(2);

            document.getElementById('map-link-input-unbalanced').value = googleMapsUrl;
            document.getElementById('map-link-input-balanced').value = googleMapsUrl;

            document.getElementById('olt-port-input').value = oltPortNumber;
            document.getElementById('dio-group-input').value = dioGroup;
            document.getElementById('fiber-color-input').value = fiberColor;
            
            renderFiberRuns();
            recalculateUnbalanced();
            recalculateBalanced();
    
            handleProjectNameChange(projectName, false); // Dont trigger save on initial load
            saveTechnicianName(technicianName, false); // Dont trigger save on initial load
        }
        
        function handleProjectNameChange(name) {
            projectName = name.trim();
            document.title = "JC-Tech Planner";
            document.getElementById('main-title').innerText = "JC-Tech Planner";
            document.getElementById('main-title-print').innerText = projectName ? `Projeto: ${projectName}` : 'Relatório de Projeto Óptico';
            triggerAutoSave();
        }
    
        function handleOltPowerChange(inputElement) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const newValue = parseFloat(inputElement.value.replace(',', '.'));
                if (!isNaN(newValue)) {
                    oltPower = newValue;
                    
                    const unbalancedInput = document.getElementById('olt-power-input-unbalanced');
                    const balancedInput = document.getElementById('olt-power-input-balanced');
                    
                    if (inputElement.id === 'olt-power-input-unbalanced') {
                        balancedInput.value = inputElement.value;
                    } else {
                        unbalancedInput.value = inputElement.value;
                    }

                    recalculateUnbalanced();
                    recalculateBalanced();
                }
            }, 500);
        }
    
        function handleCtoDataChange(event, index, networkType, field) {
             const focusedElementId = event.target.id;
             const selectionStart = event.target.selectionStart;
             clearTimeout(debounceTimer);
             debounceTimer = setTimeout(() => {
                const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                let value = event.target.value;

                if (field === 'distance' || field === 'spliceCount' || field === 'colorGroup' || field === 'outgoingColorGroup') {
                    value = parseFloat(value) || 0;
                }
                 
                if (network[index]) { 
                    network[index][field] = value; 
                }
                
                if (networkType === 'unbalanced' && field === 'splitterCto') {
                    networkSegments[index][field] = value;
                }

                if (networkType === 'unbalanced') recalculateUnbalanced();
                else recalculateBalanced();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    if (focusedElement.setSelectionRange) {
                        focusedElement.setSelectionRange(selectionStart, selectionStart);
                    }
                }

             }, 500);
        }

        function handleBalancedConfigChange(field, value) {
            balancedConfig[field] = value;
            recalculateBalanced();
            triggerAutoSave();
        }

        function handleOltDetailsChange(field, value) {
            if (field === 'oltPortNumber') oltPortNumber = value;
            if (field === 'dioGroup') dioGroup = value;
            if (field === 'fiberColor') fiberColor = value;
            triggerAutoSave();
        }

        function handleMapLinkChange(inputElement) {
            const url = inputElement.value.trim();
            googleMapsUrl = url;

            const unbalancedInput = document.getElementById('map-link-input-unbalanced');
            const balancedInput = document.getElementById('map-link-input-balanced');
            
            if (inputElement.id === 'map-link-input-unbalanced') {
                balancedInput.value = url;
            } else if (inputElement.id === 'map-link-input-balanced') {
                unbalancedInput.value = url;
            }
            triggerAutoSave();
        }

        function viewProjectMap() {
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                try {
                    new URL(googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                } catch (e) {
                    showModal("URL Inválida", "Por favor, insira um link válido começando com http:// ou https://");
                }
            } else {
                showModal("Nenhum Mapa Definido", "Por favor, insira um link do Google My Maps no campo correspondente.");
            }
        }
        
        function saveTechnicianName(name) {
            technicianName = name;
            const printElement = document.getElementById('technician-name-print');
            printElement.innerHTML = name.trim() ? `Técnico(s) Responsável(is): <span class="font-bold">${name}</span>` : '';
            triggerAutoSave();
        }

        function copyGeoLocation(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const segment = network[index];
            if (segment && segment.geo) {
                const geoString = `${segment.geo.lat}, ${segment.geo.lon}`;
                const textArea = document.createElement("textarea");
                textArea.value = geoString;
                textArea.style.position = "fixed"; 
                textArea.style.top = "-9999px";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal("Coordenadas Copiadas", `O texto "${geoString}" foi copiado para a área de transferência.`);
                } catch (err) {
                    showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas.");
                }
                document.body.removeChild(textArea);
            } else {
                showModal("Geolocalização Ausente", "Primeiro, clique em 'GPS' para capturar as coordenadas.");
            }
        }

       function openInGoogleMaps(index, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            const cto = network[index];
            
            if (!cto.geo) {
                showModal("Geolocalização Ausente", "Por favor, capture as coordenadas GPS ou insira-as manualmente primeiro.");
                return;
            }
            
            if (googleMapsUrl && googleMapsUrl.trim() !== '') {
                 const geoString = `${cto.geo.lat.toFixed(5)}, ${cto.geo.lon.toFixed(5)}`;
                 navigator.clipboard.writeText(geoString).then(() => {
                     window.open(googleMapsUrl, '_blank');
                     showModal("Coordenadas Copiadas", `As coordenadas "${geoString}" foram copiadas. Agora, cole-as no seu mapa para adicionar o ponto.`);
                 }, () => {
                     showModal("Erro ao Copiar", "Não foi possível copiar as coordenadas para a área de transferência.");
                 });
            } else {
                 const lat = cto.geo.lat;
                 const lon = cto.geo.lon;
                 const url = `https://www.google.com/maps?q=${lat},${lon}`;
                 window.open(url, '_blank');
            }
        }
    
        function getGeoLocation(index, networkType) {
            if (!navigator.geolocation) {
                showModal("Geolocalização Não Suportada", "O seu navegador não suporta a API de Geolocalização.");
                return;
            }
            
            if (window.isSecureContext === false) {
                 showModal("Conexão Insegura", "O GPS não pode ser ativado em conexões não seguras (HTTP ou local). Por favor, hospede o ficheiro num servidor com HTTPS para usar esta funcionalidade.");
                 return;
            }

            showModal("A obter localização...", "Por favor, aguarde enquanto o GPS está a ser capturado.\n\nPode ser necessário autorizar o acesso à sua localização no navegador.");
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    network[index].geo = { lat: lat, lon: lon };
                    showModal("Localização Capturada!", `As coordenadas ${lat.toFixed(5)}, ${lon.toFixed(5)} foram guardadas.`);
                    if (networkType === 'unbalanced') renderUnbalancedNetwork();
                    else renderBalancedNetwork();
                    triggerAutoSave();
                },
                (error) => {
                    let message = "Ocorreu um erro desconhecido.";
                    if (error.code === 1) { // PERMISSION_DENIED
                         message = "A permissão de acesso ao GPS foi negada.\n\nVerifique as permissões do seu navegador para este site. Lembre-se que o GPS só funciona em conexões seguras (HTTPS).";
                    } else if (error.code === 2) { // POSITION_UNAVAILABLE
                         message = "Localização indisponível. Não foi possível obter a sua posição atual.";
                    } else if (error.code === 3) { // TIMEOUT
                         message = "Tempo esgotado ao tentar obter a localização.";
                    }
                    showModal("Erro de Geolocalização", message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        function saveManualGeo(index, networkType) {
            const cardIdPrefix = networkType === 'unbalanced' ? 'U' : 'B';
            const input = document.getElementById(`manual-geo-input-${cardIdPrefix}-${index}`);
            const coordsString = input.value.trim();
            if (coordsString) {
                const parts = coordsString.replace(/ /g, '').split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
                        network[index].geo = { lat, lon };
                        if (networkType === 'unbalanced') renderUnbalancedNetwork();
                        else renderBalancedNetwork();
                        showModal("Coordenadas Guardadas", `As coordenadas ${lat}, ${lon} foram guardadas com sucesso.`);
                        input.value = '';
                        triggerAutoSave();
                        return;
                    }
                }
            }
            showModal("Formato Inválido", "Por favor, insira as coordenadas no formato 'latitude, longitude'. Ex: -12.345, -39.876");
        }

        async function shareProject() {
            let message = `*Relatório do Projeto Óptico: ${projectName || 'Não Definido'}*\n\n`;
            message += `*Técnico(s):* ${technicianName || 'N/A'}\n`;
            message += `*Potência OLT:* ${oltPower.toFixed(2)} dBm\n`;
            if (googleMapsUrl) {
                message += `*Link do Mapa:* ${googleMapsUrl}\n`;
            }
            message += `\n`;
            
            const grandTotalElement = document.querySelector('#materials-table tfoot tr td:last-child');
            if (grandTotalElement) {
                message += `*Custo Total Estimado:* ${grandTotalElement.textContent}\n\n`;
            }
            
            message += `--- *SIMULAÇÃO REDE BALANCEADA* ---\n`;
            message += `Splitter Primário: ${balancedConfig.primarySplitter}\n\n`;
            balancedNetworkCtos.forEach((cto, index) => {
                message += `*CTO Bal.-${String(index + 1).padStart(2, '0')}*\n`;
                message += `Dist.: ${cto.distance || 0}m, Fusões: ${cto.spliceCount || 0}\n`;
                message += `Splitter CTO: ${cto.splitterCto}\n`;
                message += `*Sinal Final Estimado:* ${cto.sinalFinal} dBm\n`;
                if (cto.geo) {
                    message += `Geolocalização: ${cto.geo.lat}, ${cto.geo.lon}\n`;
                }
                message += `\n`;
            });

            message += `--- *SIMULAÇÃO REDE DESBALANCEADA* ---\n\n`;
            let ctoCounter = 0;
            let spliceBoxCounter = 0;
            networkSegments.forEach((segment) => {
                const type = segment.type || 'cto';
                const colorInfo = FIBER_COLORS[segment.colorGroup || 0];
                let title = '';

                if (type === 'splice_box') {
                    spliceBoxCounter++;
                    title = `CEO/CDR-${String(spliceBoxCounter).padStart(2, '0')}`;
                } else {
                    ctoCounter++;
                    title = `CTO-${String(ctoCounter).padStart(2, '0')}`;
                }
                
                message += `*${title} (${colorInfo.name})*\n`;
                message += `Dist.: ${segment.distance || 0}m, Fusões: ${segment.spliceCount || 0}\n`;
                message += `Sinal Entrada: ${segment.sinalEntradaHub} dBm\n`;
                message += `Splitter Desb.: ${segment.splitterHub}\n`;
                message += `Sinal Saída: ${segment.sinalSaidaHub} dBm\n`;
                if(type === 'cto') {
                    message += `Splitter CTO: ${segment.splitterCto}\n`;
                    message += `*Sinal Final CTO:* ${segment.sinalFinalCto || '---'} dBm\n`;
                }
                if (segment.geo) {
                    message += `Geolocalização: ${segment.geo.lat}, ${segment.geo.lon}\n`;
                }
                message += `\n`;
            });

            const shareData = { title: `Projeto: ${projectName || 'Simulador Óptico'}`, text: message };
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) { console.error('Erro ao compartilhar:', err); }
            } else {
                showModal('Compartilhamento Indisponível', 'O seu navegador não suporta a função de compartilhamento. Pode copiar o texto manualmente.');
            }
        }
        
        function getProjectData() {
            return { 
                version: "5.6", projectName, technicianName, oltPower, googleMapsUrl,
                oltPortNumber, dioGroup, fiberColor, fiberRuns, 
                networkSegments, balancedConfig, balancedNetworkCtos, 
                manualMaterials, materialPrices, customMaterials
            };
        }

        function triggerAutoSave() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) statusEl.textContent = 'Salvando...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveState();
                if (statusEl) statusEl.textContent = 'Salvo!';
                setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 2000);
            }, 1500);
        }

        function saveState() {
            try {
                const projectData = getProjectData();
                localStorage.setItem('jcTechPlannerState', JSON.stringify(projectData));
            } catch (e) {
                console.error("Erro ao salvar o estado:", e);
                showModal("Erro de Salvamento", "Não foi possível salvar o projeto. O armazenamento pode estar cheio.");
            }
        }

        function downloadBackup() {
            const projectData = getProjectData();
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = Object.assign(document.createElement('a'), {
                href: url,
                download: `${projectName.replace(/[^a-z0-9]/gi, '_') || 'projeto_sem_nome'}.json`
            });
            document.body.appendChild(a).click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    
        function loadProjectFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadDataIntoState(data);
                    saveState(); // Salva o estado carregado no localStorage
                    showModal("Backup Carregado", `O projeto "${projectName}" foi carregado com sucesso!`);
                } catch (error) {
                    showModal("Erro ao Carregar", "O ficheiro de backup pode estar corrompido ou em formato inválido.");
                }
            };
            reader.readAsText(file);
        }
        
        function loadDataIntoState(data) {
            projectName = data.projectName || '';
            technicianName = data.technicianName || '';
            oltPower = data.oltPower || 7.00;
            googleMapsUrl = data.googleMapsUrl || '';
            oltPortNumber = data.oltPortNumber || '';
            dioGroup = data.dioGroup || '';
            fiberColor = data.fiberColor || '';
            fiberRuns = data.fiberRuns || [{ type: 'Fibra Óptica 12 FO', length: 0 }];

            if (data.networkSegments) {
                data.networkSegments.forEach(segment => {
                    if (!segment.type) segment.type = 'cto';
                    if (segment.type === 'splice_box' && !segment.spliceDetails) segment.spliceDetails = [];
                });
            }
            networkSegments = data.networkSegments || [];

            balancedConfig = data.balancedConfig || { primarySplitter: '1:8' };
            if (data.balancedNetworkCtos) {
                data.balancedNetworkCtos.forEach(item => {
                    if (!item.type) item.type = 'cto'; // Adiciona o tipo se estiver ausente para compatibilidade
                });
            }
            balancedNetworkCtos = data.balancedNetworkCtos || [];
            
            if (data.balancedConfig && data.balancedConfig.secondarySplitter) {
                balancedNetworkCtos.forEach(cto => {
                    if (!cto.splitterCto) cto.splitterCto = data.balancedConfig.secondarySplitter;
                });
                delete balancedConfig.secondarySplitter;
            } else {
                 balancedNetworkCtos.forEach(cto => {
                    if (!cto.type || cto.type === 'cto') {
                        if (!cto.splitterCto) cto.splitterCto = '1:8';
                    }
                });
            }

            manualMaterials = data.manualMaterials || {};
            materialPrices = data.materialPrices || {};
            customMaterials = data.customMaterials || [];

            updateUIWithLoadedData();
        }

        function loadStateFromStorage() {
            const savedStateJSON = localStorage.getItem('jcTechPlannerState');
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    loadDataIntoState(savedState);
                } catch(e) {
                    console.error("Erro ao carregar estado do localStorage:", e);
                    initializeDefaultProject();
                }
            } else {
                initializeDefaultProject();
            }
        }
        
        function initializeDefaultProject() {
            addCto();
            addBalancedCto();
            updateUIWithLoadedData();
            renderFiberRuns();
            updateMaterialsList();
        }
        
        function getFiberTypeOptions(selectedValue) {
            const types = ['06 FO', '12 FO', '24 FO', '36 FO', '72 FO'];
            return types.map(type => `<option value="Fibra Óptica ${type}" ${`Fibra Óptica ${type}` === selectedValue ? 'selected' : ''}>${type}</option>`).join('');
        }

        function renderFiberRuns() {
            const container = document.getElementById('fiber-runs-container');
            container.innerHTML = fiberRuns.map((run, index) => `
                <div class="flex items-center justify-center gap-4 p-2 border rounded-lg bg-white shadow-sm">
                    <div class="flex-1 flex flex-col">
                        <label class="font-semibold text-gray-600 mb-1 text-sm">Tipo de Fibra</label>
                        <select onchange="handleFiberRunChange(${index}, 'type', this.value)" class="w-full text-center p-2 rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                            ${getFiberTypeOptions(run.type)}
                        </select>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <label class="font-semibold text-gray-600 mb-1 text-sm">Metragem (m)</label>
                        <input oninput="handleFiberRunChange(${index}, 'length', this.value)" type="number" value="${run.length || ''}" placeholder="Ex: 5000" class="w-full text-center rounded-md font-bold border-2 border-gray-300 focus:border-indigo-500">
                    </div>
                    <button onclick="removeFiberRun(${index})" title="Remover Lançamento" class="p-2 bg-red-100 text-red-600 rounded-md hover:bg-red-200 transition-colors self-end mt-5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');
        }

        function addFiberRun() {
            fiberRuns.push({ type: 'Fibra Óptica 12 FO', length: 0 });
            renderFiberRuns();
            updateMaterialsList();
            triggerAutoSave();
        }

        function removeFiberRun(index) {
            if (fiberRuns.length > 1) {
                fiberRuns.splice(index, 1);
                renderFiberRuns();
                updateMaterialsList();
                triggerAutoSave();
            } else {
                showModal("Ação Inválida", "Não é possível remover o último lançamento de fibra.");
            }
        }

        function handleFiberRunChange(index, field, value) {
            fiberRuns[index][field] = (field === 'length') ? (parseFloat(value) || 0) : value;
            updateMaterialsList();
            triggerAutoSave();
        }

        function saveManualMaterial(event, id, value) {
            const focusedElementId = event.target.id;
            const selectionStart = event.target.selectionStart;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                manualMaterials[id] = parseInt(value, 10) || 0;
                updateMaterialsList();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    focusedElement.setSelectionRange(selectionStart, selectionStart);
                }
                triggerAutoSave();
            }, 500);
        }
        
        function saveMaterialPrice(event, id, value) {
            const focusedElementId = event.target.id;
            const selectionStart = event.target.selectionStart;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const price = parseFloat(value.replace(',', '.')) || 0;
                materialPrices[id] = price;
                updateMaterialsList();
                
                const focusedElement = document.getElementById(focusedElementId);
                if (focusedElement) {
                    focusedElement.focus({ preventScroll: true });
                    focusedElement.setSelectionRange(selectionStart, selectionStart);
                }
                triggerAutoSave();
            }, 500);
        }
        
        function addSpliceBox() {
            const lastSegment = networkSegments.length > 0 ? networkSegments[networkSegments.length - 1] : { colorGroup: -1 };
            const incomingColor = lastSegment.outgoingColorGroup !== undefined ? lastSegment.outgoingColorGroup : (lastSegment.colorGroup + 1) % 12;

            networkSegments.push({
                type: 'splice_box',
                splitterHub: 'Ausente',
                splitterCto: 'Ausente', 
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: incomingColor,
                outgoingColorGroup: (incomingColor + 1) % 12,
                spliceDetails: []
            });
            recalculateUnbalanced();
            triggerAutoSave();
        }

        function addCto() {
            const lastSegment = networkSegments.length > 0 ? networkSegments[networkSegments.length - 1] : { colorGroup: -1 };
            const incomingColor = lastSegment.outgoingColorGroup !== undefined ? lastSegment.outgoingColorGroup : (lastSegment.colorGroup + 1) % 12;
            
            networkSegments.push({
                type: 'cto',
                splitterHub: 'Ausente',
                splitterCto: 'Ausente', 
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: incomingColor,
            });
            recalculateUnbalanced();
            triggerAutoSave();
        }
        
        function removeNetworkSegment(index) {
            if (networkSegments.length > 0) {
                networkSegments.splice(index, 1);
                recalculateUnbalanced();
                triggerAutoSave();
            }
        }

        function addBalancedCto() {
            const lastCto = balancedNetworkCtos.length > 0 ? balancedNetworkCtos[balancedNetworkCtos.length - 1] : { colorGroup: -1 };
            const newColorGroup = lastCto ? (lastCto.colorGroup + 1) % 12 : 0;
            balancedNetworkCtos.push({ 
                type: 'cto',
                distance: 0, 
                spliceCount: 0, 
                geo: null, 
                description: '', 
                colorGroup: newColorGroup,
                splitterCto: '1:8'
            });
            recalculateBalanced();
            triggerAutoSave();
        }
        
        function addBalancedSpliceBox() {
            const lastItem = balancedNetworkCtos.length > 0 ? balancedNetworkCtos[balancedNetworkCtos.length - 1] : { colorGroup: -1 };
            const incomingColor = lastItem.outgoingColorGroup !== undefined ? lastItem.outgoingColorGroup : (lastItem.colorGroup + 1) % 12;

            balancedNetworkCtos.push({
                type: 'splice_box',
                distance: 0,
                spliceCount: 0,
                geo: null,
                description: '',
                colorGroup: incomingColor,
                outgoingColorGroup: (incomingColor + 1) % 12,
                spliceDetails: []
            });
            recalculateBalanced();
            triggerAutoSave();
        }

        function removeBalancedItem(index) {
            if (balancedNetworkCtos.length > 0) {
                balancedNetworkCtos.splice(index, 1);
                recalculateBalanced();
                triggerAutoSave();
            }
        }
        
        // --- Novas funções para detalhes da fusão ---
        function addSpliceDetail(segmentIndex, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].type === 'splice_box') {
                if (!network[segmentIndex].spliceDetails) {
                    network[segmentIndex].spliceDetails = [];
                }
                network[segmentIndex].spliceDetails.push({ color1: 0, color2: 0 });
                if (networkType === 'unbalanced') {
                    renderUnbalancedNetwork();
                } else {
                    renderBalancedNetwork();
                }
                triggerAutoSave();
            }
        }

        function removeSpliceDetail(segmentIndex, detailIndex, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].spliceDetails) {
                network[segmentIndex].spliceDetails.splice(detailIndex, 1);
                 if (networkType === 'unbalanced') {
                    renderUnbalancedNetwork();
                } else {
                    renderBalancedNetwork();
                }
                triggerAutoSave();
            }
        }

        function handleSpliceDetailChange(event, segmentIndex, detailIndex, colorKey, networkType) {
            const network = networkType === 'unbalanced' ? networkSegments : balancedNetworkCtos;
            if (network[segmentIndex] && network[segmentIndex].spliceDetails[detailIndex]) {
                network[segmentIndex].spliceDetails[detailIndex][colorKey] = parseInt(event.target.value, 10);
                if (networkType === 'unbalanced') {
                    renderUnbalancedNetwork();
                } else {
                    renderBalancedNetwork();
                }
                triggerAutoSave();
            }
        }
        
        // --- Novas funções para materiais customizados ---
        function addCustomMaterial() {
            customMaterials.push({
                id: `custom_${Date.now()}`,
                name: 'Novo Item Editável',
                qty: 0,
                price: 0
            });
            updateMaterialsList();
            triggerAutoSave();
        }

        function removeCustomMaterial(index) {
            customMaterials.splice(index, 1);
            updateMaterialsList();
            triggerAutoSave();
        }

        function handleCustomMaterialChange(event, index, field) {
            if (customMaterials[index]) {
                let value = event.target.value !== undefined ? event.target.value : event.target.innerText;
                if (field === 'price') {
                    value = parseFloat(value.replace(',', '.')) || 0;
                } else if (field === 'qty') {
                    value = parseInt(value, 10) || 0;
                }
                customMaterials[index][field] = value;
                
                // Apenas um pequeno atraso para re-renderizar, para não interromper a digitação
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updateMaterialsList();
                    triggerAutoSave();
                }, 500);
            }
        }


        // --- LÓGICA DA CALCULADORA ---
        let currentInput = '0';
        let operator = null;
        let previousInput = null;
        let shouldResetDisplay = false;

        function openCalculatorModal() {
            document.getElementById('calculatorModal').style.display = 'flex';
        }

        function closeCalculatorModal() {
            document.getElementById('calculatorModal').style.display = 'none';
        }

        function updateDisplay() {
            document.getElementById('calc-display').textContent = currentInput;
        }

        function handleNumber(value) {
            if (currentInput === '0' || shouldResetDisplay) {
                currentInput = value;
                shouldResetDisplay = false;
            } else {
                currentInput += value;
            }
        }

        function handleOperator(value) {
            if (operator && !shouldResetDisplay) {
                calculate();
            }
            previousInput = currentInput;
            operator = value;
            shouldResetDisplay = true;
        }

        function handleDecimal() {
            if (shouldResetDisplay) {
                currentInput = '0.';
                shouldResetDisplay = false;
                return;
            }
            if (!currentInput.includes('.')) {
                currentInput += '.';
            }
        }

        function clearCalculator() {
            currentInput = '0';
            operator = null;
            previousInput = null;
            shouldResetDisplay = false;
        }

        function calculate() {
            if (!operator || previousInput === null) return;
            const prev = parseFloat(previousInput);
            const current = parseFloat(currentInput);
            if (isNaN(prev) || isNaN(current)) return;
            
            let result;
            switch (operator) {
                case '+': result = prev + current; break;
                case '-': result = prev - current; break;
                case '*': result = prev * current; break;
                case '/': 
                    if (current === 0) {
                        currentInput = 'Erro';
                        updateDisplay();
                        setTimeout(clearCalculator, 1500);
                        return;
                    }
                    result = prev / current; 
                    break;
                default: return;
            }
            currentInput = String(result);
            operator = null;
            previousInput = null;
            shouldResetDisplay = true;
        }


        // --- LÓGICA DA PREVISÃO DO TEMPO ---
        function openWeatherModal() {
            document.getElementById('weatherModal').style.display = 'flex';
        }
        function closeWeatherModal() {
            document.getElementById('weatherModal').style.display = 'none';
        }

        function getWeatherIcon(code) {
            const icons = {
                0: '☀️', 1: '🌤️', 2: '⛅', 3: '☁️', 45: '🌫️', 48: '🌫️',
                51: '🌦️', 53: '🌦️', 55: '🌦️', 56: '🥶', 57: '🥶',
                61: '🌧️', 63: '🌧️', 65: '🌧️', 66: '🥶', 67: '🥶',
                71: '❄️', 73: '❄️', 75: '❄️', 77: '❄️',
                80: '🌧️', 81: '🌧️', 82: '🌧️', 85: '❄️', 86: '❄️',
                95: '⛈️', 96: '⛈️', 99: '⛈️',
            };
            return icons[code] || '❓';
        }

        async function fetchWeatherData(lat, lon, cityName) {
            const weatherCityEl = document.getElementById('weatherCity');
            const weatherTempEl = document.getElementById('weatherTemp');
            const weatherIconEl = document.getElementById('weatherIcon');
            const weatherForecastEl = document.getElementById('weatherForecast');

            weatherCityEl.textContent = 'Buscando...';
            weatherTempEl.textContent = '--° / --°';
            weatherIconEl.innerHTML = '';
            weatherForecastEl.innerHTML = '';

            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                if (!response.ok) throw new Error('Não foi possível obter a previsão do tempo.');
                
                const data = await response.json();
                if (!data.daily) throw new Error('Dados de previsão inválidos.');

                // --- Clima Atual (Hoje) ---
                const today = data.daily;
                weatherCityEl.textContent = cityName;
                weatherIconEl.textContent = getWeatherIcon(today.weathercode[0]);
                weatherTempEl.innerHTML = `<span class="font-bold">${Math.round(today.temperature_2m_max[0])}°</span> <span class="text-gray-500">${Math.round(today.temperature_2m_min[0])}°</span>`;

                // --- Previsão dos Próximos Dias ---
                const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                weatherForecastEl.innerHTML = ''; 
                
                for(let i = 1; i < 7 && i < today.time.length; i++) {
                    const date = new Date(today.time[i] + 'T00:00:00');
                    const dayOfWeek = weekDays[date.getDay()];
                    
                    const forecastDayEl = document.createElement('div');
                    forecastDayEl.className = 'text-center text-xs p-1 bg-gray-200 rounded-md flex-1';
                    forecastDayEl.innerHTML = `
                        <div class="font-bold">${dayOfWeek}</div>
                        <div class="text-2xl my-0.5">${getWeatherIcon(today.weathercode[i])}</div>
                        <div>
                            <span class="font-semibold text-black">${Math.round(today.temperature_2m_max[i])}°</span>
                            <span class="text-gray-500">${Math.round(today.temperature_2m_min[i])}°</span>
                        </div>
                    `;
                    weatherForecastEl.appendChild(forecastDayEl);
                }
                 localStorage.setItem('jcTechPlannerWeatherCity', cityName);

            } catch (error) {
                weatherCityEl.textContent = 'Erro ao buscar';
                console.error("Erro no clima:", error);
            }
        }
        
        async function getWeatherByCity(city) {
             try {
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=pt&format=json`);
                if (!geoResponse.ok) throw new Error('Cidade não encontrada.');

                const geoData = await geoResponse.json();
                if (!geoData.results || geoData.results.length === 0) throw new Error('Cidade não encontrada.');
                
                const { latitude, longitude, name } = geoData.results[0];
                fetchWeatherData(latitude, longitude, name);

            } catch (error) {
                document.getElementById('weatherCity').textContent = 'Cidade inválida';
                console.error("Erro de geocodificação:", error);
            }
        }

        function initializeWeather() {
            const savedCity = localStorage.getItem('jcTechPlannerWeatherCity');
            if (navigator.geolocation && !savedCity) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeatherData(latitude, longitude, 'Localização Atual');
                    },
                    () => { 
                        getWeatherByCity('Brasilia'); // Fallback
                    }
                );
            } else {
                getWeatherByCity(savedCity || 'Brasilia'); // Fallback
            }
        }
        

        window.onload = function() {
            loadStateFromStorage();
            initializeWeather();

            // Event Listeners da Calculadora
            const closeCalcModalBtn = document.getElementById('closeCalcModalBtn');
            const calculatorModal = document.getElementById('calculatorModal');
            const calcBtns = document.querySelectorAll('.calc-btn');
            if (closeCalcModalBtn) closeCalcModalBtn.addEventListener('click', closeCalculatorModal);
            if (calculatorModal) calculatorModal.addEventListener('click', (e) => {
                if (e.target === calculatorModal) closeCalculatorModal();
            });
            calcBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const { value } = button.dataset;
                    if (!isNaN(parseFloat(value))) {
                        handleNumber(value);
                    } else if (value === '.') {
                        handleDecimal();
                    } else if (value === 'clear') {
                        clearCalculator();
                    } else if (value === '=') {
                        calculate();
                    } else {
                        handleOperator(value);
                    }
                    updateDisplay();
                });
            });

            // Event Listeners da Previsão do Tempo
            const closeWeatherModalBtn = document.getElementById('closeWeatherModalBtn');
            const weatherModal = document.getElementById('weatherModal');
            const updateWeatherBtn = document.getElementById('updateWeatherBtn');
            const cityInput = document.getElementById('cityInput');

            if (closeWeatherModalBtn) closeWeatherModalBtn.addEventListener('click', closeWeatherModal);
            if(weatherModal) weatherModal.addEventListener('click', (e) => {
                if(e.target === weatherModal) closeWeatherModal();
            });

            if (updateWeatherBtn) {
                updateWeatherBtn.addEventListener('click', () => {
                    const city = cityInput.value.trim();
                    if(city) getWeatherByCity(city);
                });
            }
            if (cityInput) {
                cityInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                         const city = cityInput.value.trim();
                         if(city) getWeatherByCity(city);
                    }
                });
            }
        };
    </script>
</body>
</html>

